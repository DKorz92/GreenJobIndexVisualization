<div id="industryGraphPanel">
    <div id="industryGraphList" class="selectionList" style="overflow:scroll; font-size: 1.3em;">
        <h3>Possible industries:</h3>
        <ol id="selectedIndustryList"></ol>
    </div>
    <div id="industryGraphDiv" style="overflow:scroll";>
        <svg id="industryGraph"></svg>
    </div>
    <div id="industryGraphDivAxis";>
        <svg id="industryGraphAxisTitle"></svg>
        <svg id="industryGraphAxis"></svg>
    </div>
    <div id="industrySpecDiv">

    </div>
    <script>
        width = g_width*2/3;
        height = g_height*5/5
		function IndustryGraph(){
			this.dataInput = [];
		    this.dataArray = [];
			this.selectedMSACode = "";
			this.selectedMSAIndex = -1;
			this.heightScale = d3.scale.linear()
				.domain([1,0])
				.range([10,height-30]);
			this.widthScale = d3.scale.linear()
				.domain([0,1])
				.range([50,width-50]);
			this.xAxis = d3.svg.axis()
				.scale(this.widthScale)
				.orient("bottom")
			this.canvas = d3.select("#industryGraph")
			    .style("position","absolute")
				.attr("width",g_width*2/3)
				.attr("height",g_height*5/5)
				//.style("left",g_width*1/3+"px")
        	    //.style("top",g_height*0/5+"px")
				//.attr("transform","translate(50,20)");
		    this.canvasAxis = d3.select("#industryGraphAxis")
			    .style("position","absolute")
				.attr("width",g_width*2/3)
				.attr("height",g_height*1/10)
				.style("top",g_height*1/20);
				//.style("left",g_width*1/3+"px")
        	    //.style("top",g_height*0/5+"px")
				//.attr("transform","translate(50,20)");
		    d3.select("#industryGraphAxisTitle")
			    .style("position","absolute")
				.attr("width",g_width*2/3)
				.attr("height",g_height*1/10)
		    d3.select("#industryGraphDiv")
		        .style("position","absolute")
				.style("width",g_width*2/3)
				.style("height",g_height*16/20)
				.style("left",g_width*1/3+"px")
        	    .style("top",g_height*2/20+"px")
        	d3.select("#industryGraphDivAxis")
		        .style("position","absolute")
				.style("width",g_width*2/3)
				.style("height",g_height*2/20)
				.style("left",g_width*1/3+"px")
        	    .style("top",g_height*0/10+"px")
			this.fields = this.canvas.append("g");
			this.fields = d3.select("#industryGraphDiv")
			this.list = d3.select("#industryGraphList")
			    .style("position","absolute")
			    .style("width",g_width*1/3)
			    .style("height",g_height*4/5)
			    .style("left","0px")
        	    .style("top",g_height*0/5+"px")
            parent = this;
        	d3.select("#industrySpecDiv")
        	    .style("position","absolute")
			    .style("width",g_width*3/3)
			    .style("height",g_height*1/5)
			    .style("left","0px")
        	    .style("top",g_height*4/5+"px")
        	    .append("button")
			        .attr("class","button")
			        //.style("position","absolute")
			        //.style("height",g_height*1/10)
			        //.style("width",g_width*1/8)
			        .text("Show 10-year-projection")
			        .on("click",function(){
			            parent.useProj = !parent.useProj;
			            d3.select(this).text(function(){
			                if(!parent.useProj){return "Show 10-year-projection";}
			                else { return "Show actual data";}
			            });
			            parent.redrawStep2()
			        });
            this.useProj = false;
			this.codeToIndex = function(code){
			    for(var i=0;i<g_dataState.p_selectedOccupations.length;i++){
			        if(g_dataState.p_selectedOccupations[i].code == code){
			            return i;
			        }
			    }
			    alert("Error in Industrypanel!")
			    return -1;
			}
			this.match = function(data){
    			this.dataArray = []
    			for(var i=0;i<data.length;i++){
    			    result = this.dataArray.filter(function(o){return o.ind_code == data[i].ind_code;});
    			    if(result.length==0){
    			        var nullArray = []
    			        for(var j=0;j<g_dataState.p_selectedOccupations.length;j++)nullArray.push({base: 0,proj: 0,get: function(b){if(b){return this.proj-this.base} else{ return this.base}}});
    			        obj = {ind_code: data[i].ind_code, values: nullArray,title: data[i].title }
    			        result = [obj];
    			        this.dataArray.push(obj);
    			    }else{
    			        //alert("Doppelte gefunden fÃ¼r "+data[i].ind_code+": "+data[i].title);
    			    }
    			    result[0].values[this.codeToIndex(data[i].occ_code)].base = data[i].base;
    			    result[0].values[this.codeToIndex(data[i].occ_code)].proj = data[i].proj;
    			}
    			//alert(JSON.stringify(this.dataArray));
				/*for(var i=0;i<this.dataInput.length;i++){
				    for(var j=0;j<data.values.length;j++){
				        if(data.values[j].code == this.dataInput[i].code){
				            if(data.values[j].local_quot<1)this.dataArray.push(this.dataInput[i]);
				            break;
				        }
				    }
				}*/
				//this.dataArray = data;
			}
			this.checkSelection = function(data){
			    for(var j=0;j<this.dataArray.length;j++){
                    found = false
                    for(var i=0;i<data.length;i++){
                        if(data[i].code == this.dataArray[j].ind_code){
                            found = true;
                            break;
                        }
                    }
                    this.dataArray[j].selected = found;
                }
			}

			this.redraw = function () {
			    if(g_dataState.p_selectedOccupations.length>0){
                    var client = new HttpClient();
                    var loadingPanel = new LoadingPanel(d3.select("#industryGraphPanel"));
                    var parent = this;
                    client.get('/getIndustries/'+JSON.stringify(g_dataState.p_selectedOccupations), function(response) {
                            //alert(response)
                        data = JSON.parse(response);
            		    parent.match(data);
                        parent.redrawStep2();
                        loadingPanel.exit()
                    });
			    }else{
			        if(g_dataState.p_selectedIndustries.length>0){
			            g_dataState.p_selectedIndustries = [];
			            g_refreshAll();
			        }else{
			            this.match([]);
			            this.redrawStep2();
			        }

			    }

			}
			this.redrawStep2 = function(){
			    parent = this;

			    d3.select("#industryGraphAxisTitle").select("text").text(function(){
			        if(parent.useProj){
			           return "Expected change in 10 years";
			        }else{
			           return "Percentage workers of selected occupations in each industry"
			        }
			    });

				var widthScale = this.widthScale;
				var heightScale = this.heightScale;

				var rectWidth = 50;
				var rectSpace = 10;

                this.canvas.attr("height",(this.dataArray.length)*(rectWidth+rectSpace));

				var min = 100;
				var max = 0;
				for(var i=0;i<this.dataArray.length;i++){
				    for( var j=0;j<this.dataArray[i].values.length;j++){
				        var value = this.dataArray[i].values[j].get(this.useProj);
				        if(value<min) min= value;
				        if(value>max) max = value;
				    }
				}
				//min = 0
				//max = 100

    			widthScale.domain([min,max]);

                this.checkSelection(g_dataState.p_selectedIndustries);

                var listElements = this.list.selectAll("li")
                    .data(this.dataArray);
                listElements.enter()
                    .append("li")
                    .on("click",function(d){
                        d.selected = !d.selected;
    					if(d.selected){
    					    g_dataState.p_selectedIndustries.push({name:d.title,code:d.ind_code});
    				    }else{
    					    for(var i=0;i<g_dataState.p_selectedIndustries.length;i++){
    					        var obj = g_dataState.p_selectedIndustries[i]
    					        if(obj.code == d.ind_code){
    					            g_dataState.p_selectedIndustries.splice(g_dataState.p_selectedIndustries.indexOf(obj),1);
    					        }
    					    }
    				    }
    				    g_refreshAll();
    				})
    				.on("mouseover",function(){
    			        d3.select(this).classed("industryHover",true);
    			    })
    			    .on("mouseout",function(){
    			        d3.select(this).classed("industryHover",false);
    			    });
    		    listElements.classed("industrySelected",function(d){return d.selected;}).text(function(d){return d.title+" ("+d.ind_code+")"})
    			listElements.exit()
					.remove();
				var innerWidth = widthScale(max)-widthScale(min) -20
				var innerHeightScale = d3.scale.linear()
				    .domain([0,g_dataState.p_selectedOccupations.length])
				    .range([rectWidth*2/10,rectWidth*8/10]);
				var innerWidthScale = d3.scale.linear()
				    .domain([min,max])
				    .range([0,innerWidth]);

				this.xAxis.scale(widthScale);
    			this.canvasAxis.select(".xAxis").call(this.xAxis);
    			heightScale.domain([this.dataArray.length,0]);

    		    var fieldGs = this.fields.selectAll("svg")
					.data(this.dataArray)
					.classed("industrySelected",function(d){return d.selected;});
				var fieldGsEnter = fieldGs.enter()
					.append("svg")
					.style("position","absolute")
					.style("width",widthScale(max)-widthScale(min))
					.style("height",rectWidth)
					.style("left",widthScale(min)+"px")
					.style("top",function(d,i){return (i)*(rectWidth+rectSpace)+"px";})
					.on("click",function(d){
                        d.selected = !d.selected;
    					if(d.selected){
    					    g_dataState.p_selectedIndustries.push({name:d.title,code:d.ind_code});
    				    }else{
    					    for(var i=0;i<g_dataState.p_selectedIndustries.length;i++){
    					        var obj = g_dataState.p_selectedIndustries[i]
    					        if(obj.code == d.ind_code){
    					            g_dataState.p_selectedIndustries.splice(g_dataState.p_selectedIndustries.indexOf(obj),1);
    					        }
    					    }
    				    }
    				    g_refreshAll();
    				})
    			    .on("mouseover",function(){
    			        d3.select(this).classed("industryHover",true);
    			    })
    			    .on("mouseout",function(){
    			        d3.select(this).classed("industryHover",false);
    			    })
    	        fieldGsEnter.append("rect");
    			    //.append("title")
    		            //.text(function(d){return d.title});
				fieldGs.exit()
					.remove();
				fieldGs.select("rect").transition()
				    .duration(500)
				    //.attr("x",widthScale(min))
				    .attr("width",widthScale(max))
				    //.attr("y",function(d,i){return (i+1)*(rectWidth+rectSpace);})
				    .attr("height",rectWidth)
				    //.attr("visibility", "hidden");
				    .attr("fill","#F6F6F6")
				    .attr("stroke-dasharray","5,5")

				var lines = fieldGs.selectAll("line").data(function(d){return d.values;})
				lines.enter().append("line")
				lines.exit().remove();
				lines.transition()
					.duration(500)
					.attr("y1",function(d,i){return innerHeightScale(i);})
					.attr("y2",function(d,i){return innerHeightScale(i);})
					.attr("x1",function(d){if(!parent.useProj)return innerWidthScale(min); else return innerWidthScale(0)})
					.attr("x2",function(d){return innerWidthScale(d.get(parent.useProj));})
					.attr("stroke",function(d,i){return g_occColorList[i%g_occColorList.length]})
				/*this.canvas.selectAll("title")
					.data(this.dataArray)
					.text(function(d){return d.title});*/

    		}
		}
		var iG = new IndustryGraph();
		iG.canvasAxis.append("g")
			.attr("class","xAxis")
			//.attr("transform","translate(0,"+(height-100)+")")
			.attr("stroke","none")
			.call(iG.xAxis);
		//d3.select("body").style("width",width+"px").style("margin-left","20px");
        d3.select("#industryGraphAxisTitle").append("text").attr("y",20).attr("x",50)
        g_register("Industry Graph Panel",function(){iG.redraw()},"industryGraphPanel","Industry Selection");
	</script>
</div>
